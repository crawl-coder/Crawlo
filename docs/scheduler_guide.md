# 定时任务调度器使用文档

## 📋 功能概述

定时任务调度器是 Crawlo 框架内置的任务调度系统，支持基于 cron 表达式的定时任务配置，可以自动执行爬虫任务。

### 主要特性

- ✅ 支持 cron 表达式（类似 Linux crontab）
- ✅ 支持多任务并发执行
- ✅ 支持任务优先级配置
- ✅ 支持任务超时控制
- ✅ 实时显示当前时间、下次运行时间、距离下次运行时间
- ✅ 支持任务执行统计

## 🚀 快速开始

### 1. 启用定时任务

在项目的 `settings.py` 文件中添加以下配置：

```python
# 启用定时任务
SCHEDULER_ENABLED = True
```

### 2. 配置定时任务

```python
# 定时任务配置
SCHEDULER_JOBS = [
    {
        'spider': 'of_week',           # 爬虫名称（对应spider的name属性）
        'cron': '*/2 * * * *',       # 每2分钟执行一次
        'enabled': True,              # 任务启用状态
        'args': {},                  # 传递给爬虫的参数
        'priority': 10               # 任务优先级
    }
]
```

### 3. 启动调度器

```bash
python run.py --schedule
```

## ⚙️ 配置参数说明

### 基础配置

| 参数 | 类型 | 默认值 | 说明 |
|------|------|--------|------|
| `SCHEDULER_ENABLED` | bool | False | 是否启用定时任务 |
| `SCHEDULER_JOBS` | list | [] | 定时任务配置列表 |

### 高级配置

| 参数 | 类型 | 默认值 | 说明 |
|------|------|--------|------|
| `SCHEDULER_CHECK_INTERVAL` | int | 1 | 调度器检查间隔（秒） |
| `SCHEDULER_MAX_CONCURRENT` | int | 3 | 最大并发任务数 |
| `SCHEDULER_JOB_TIMEOUT` | int | 3600 | 单个任务超时时间（秒） |

### 任务配置

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| `spider` | str | ✅ | 爬虫名称（对应spider的name属性） |
| `cron` | str | ✅ | cron表达式 |
| `enabled` | bool | ❌ | 任务启用状态（默认True） |
| `args` | dict | ❌ | 传递给爬虫的参数（默认{}） |
| `priority` | int | ❌ | 任务优先级（默认10） |

## 📅 Cron 表达式

Cron 表达式格式：`分 时 日 月 周`

### 字段说明

| 字段 | 取值范围 | 说明 |
|------|----------|------|
| 分 | 0-59 | 分钟 |
| 时 | 0-23 | 小时 |
| 日 | 1-31 | 日期 |
| 月 | 1-12 | 月份 |
| 周 | 0-6 | 星期（0=周日） |

### 特殊字符

| 字符 | 说明 | 示例 |
|------|------|------|
| `*` | 任意值 | `* * * * *`（每分钟） |
| `,` | 列表分隔符 | `0,15,30,45 * * * *`（每15分钟） |
| `-` | 范围 | `0-5 * * * *`（每小时前5分钟） |
| `/` | 步长 | `*/2 * * * *`（每2分钟） |
| `?` | 不指定值（仅用于日和周） | `0 0 ? * 1`（每周一） |

### 常用示例

| Cron 表达式 | 说明 |
|------------|------|
| `*/1 * * * *` | 每1分钟执行一次 |
| `*/2 * * * *` | 每2分钟执行一次 |
| `*/5 * * * *` | 每5分钟执行一次 |
| `0 * * * *` | 每小时执行一次 |
| `0 */2 * * *` | 每2小时执行一次 |
| `0 0 * * *` | 每天凌晨执行一次 |
| `0 0 * * 1` | 每周一凌晨执行一次 |
| `0 0 1 * *` | 每月1号凌晨执行一次 |
| `0 9-18 * * 1-5` | 工作日9点到18点每小时执行一次 |
| `0 0,12 * * *` | 每天凌晨和中午12点执行一次 |

## 📊 启动信息

启动调度器时会显示以下信息：

```
================================================================================
定时任务调度器
================================================================================
当前时间: 2026-01-11 19:46:29
任务数量: 1

任务: of_week
  下次运行时间: 2026-01-11 19:48:00
  距离下次运行: 1 分钟

================================================================================
调度器主循环启动，等待任务执行...
================================================================================
```

## 📈 运行日志

调度器运行时会输出详细的日志信息：

```
2026-01-11 19:48:00,000 - [SchedulerDaemon] - INFO: 调度任务: of_week
2026-01-11 19:48:00,001 - [of_week] - INFO: 爬取任务开始
...
2026-01-11 19:48:06,000 - [of_week] - INFO: 爬取任务结束
2026-01-11 19:48:06,001 - [SchedulerDaemon] - INFO: 任务执行成功: of_week
```

## 🔧 高级用法

### 多任务配置

```python
SCHEDULER_JOBS = [
    {
        'spider': 'of_week',
        'cron': '*/2 * * * *',
        'enabled': True,
        'args': {},
        'priority': 10
    },
    {
        'spider': 'other_spider',
        'cron': '0 */4 * * *',
        'enabled': True,
        'args': {'param1': 'value1'},
        'priority': 5
    }
]
```

### 传递参数给爬虫

```python
SCHEDULER_JOBS = [
    {
        'spider': 'my_spider',
        'cron': '0 0 * * *',
        'enabled': True,
        'args': {
            'start_url': 'https://example.com',
            'max_pages': 100
        },
        'priority': 10
    }
]
```

### 动态启用/禁用任务

```python
SCHEDULER_JOBS = [
    {
        'spider': 'of_week',
        'cron': '*/2 * * * *',
        'enabled': True,   # 设置为 False 可禁用该任务
        'args': {},
        'priority': 10
    }
]
```

## ❓ 常见问题

### Q1: 如何停止调度器？

**A:** 按 `Ctrl+C` 停止调度器。

### Q2: 如何修改调度间隔？

**A:** 修改 `settings.py` 中的 `SCHEDULER_JOBS` 配置，然后重启调度器。

### Q3: 如何查看任务执行统计？

**A:** 调度器会在日志中输出任务执行统计信息，包括：
- 总执行次数
- 成功次数
- 失败次数
- 最后执行时间
- 最后成功时间
- 最后失败时间

### Q4: 任务执行超时怎么办？

**A:** 可以通过 `SCHEDULER_JOB_TIMEOUT` 参数调整超时时间，默认为 3600 秒（1小时）。

### Q5: 如何限制并发任务数？

**A:** 通过 `SCHEDULER_MAX_CONCURRENT` 参数设置最大并发任务数，默认为 3。

### Q6: 调度器不执行任务怎么办？

**A:** 检查以下几点：
1. 确认 `SCHEDULER_ENABLED = True`
2. 确认任务配置中的 `enabled = True`
3. 确认 cron 表达式格式正确
4. 检查日志中是否有错误信息

## 📝 完整配置示例

```python
# settings.py

# 启用定时任务
SCHEDULER_ENABLED = True

# 定时任务配置
SCHEDULER_JOBS = [
    {
        'spider': 'of_week',
        'cron': '*/2 * * * *',
        'enabled': True,
        'args': {},
        'priority': 10
    },
    {
        'spider': 'news_spider',
        'cron': '0 */4 * * *',
        'enabled': True,
        'args': {'category': 'tech'},
        'priority': 5
    }
]

# 定时任务高级配置
SCHEDULER_CHECK_INTERVAL = 1      # 调度器检查间隔（秒）
SCHEDULER_MAX_CONCURRENT = 3      # 最大并发任务数
SCHEDULER_JOB_TIMEOUT = 3600      # 单个任务超时时间（秒）
```

## 🎯 最佳实践

1. **合理设置调度间隔**：避免过于频繁的调度，以免对目标网站造成压力
2. **设置合理的超时时间**：根据任务执行时间调整 `SCHEDULER_JOB_TIMEOUT`
3. **使用优先级**：对于重要任务设置更高的优先级
4. **监控日志**：定期查看调度器日志，确保任务正常执行
5. **错误处理**：在爬虫中添加适当的错误处理机制

## 📚 相关文档

- [Crawlo 框架文档](../../README.md)
- [爬虫开发指南](../spider_guide.md)
- [配置文件说明](../settings_guide.md)
