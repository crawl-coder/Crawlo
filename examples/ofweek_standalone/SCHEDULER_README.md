# OFweek 爬虫定时任务使用指南

## 🚀 快速开始

### 1. 启动定时任务

```bash
python run.py --schedule
```

### 2. 启动信息

启动后会显示：

```
================================================================================
定时任务调度器
================================================================================
当前时间: 2026-01-11 19:46:29
任务数量: 1

任务: of_week
  下次运行时间: 2026-01-11 19:48:00
  距离下次运行: 1 分钟

================================================================================
调度器主循环启动，等待任务执行...
================================================================================
```

### 3. 停止调度器

按 `Ctrl+C` 停止调度器。

## ⚙️ 配置说明

定时任务配置位于 `ofweek_standalone/settings.py`：

```python
# 启用定时任务
SCHEDULER_ENABLED = True

# 定时任务配置
SCHEDULER_JOBS = [
    {
        'spider': 'of_week',           # 爬虫名称
        'cron': '*/2 * * * *',       # 每2分钟执行一次
        'enabled': True,              # 任务启用状态
        'args': {},                  # 传递给爬虫的参数
        'priority': 10               # 任务优先级
    }
]

# 定时任务高级配置
SCHEDULER_CHECK_INTERVAL = 1      # 调度器检查间隔（秒）
SCHEDULER_MAX_CONCURRENT = 3      # 最大并发任务数
SCHEDULER_JOB_TIMEOUT = 3600      # 单个任务超时时间（秒）

# 资源监控配置（可选）
SCHEDULER_RESOURCE_MONITOR_ENABLED = True   # 是否启用资源监控
SCHEDULER_RESOURCE_CHECK_INTERVAL = 300   # 资源检查间隔（秒），默认5分钟
SCHEDULER_RESOURCE_LEAK_THRESHOLD = 3600  # 资源泄露检测阈值（秒），默认1小时
```

## 🔍 资源监控

调度器内置了资源监控功能，可以检测资源使用情况和潜在的资源泄露。

### 监控功能

- **资源统计**：显示活跃资源数量和按类型分布
- **资源泄露检测**：检测超过阈值的未清理资源
- **系统资源监控**：显示内存和 CPU 使用情况
- **垃圾回收**：定期执行 Python 垃圾回收

### 监控日志示例

```
2026-01-11 20:10:00,000 - [SchedulerDaemon] - INFO: 资源监控 - 活跃资源: 5, 内存: 125.50MB, CPU: 2.3%
2026-01-11 20:10:00,001 - [SchedulerDaemon] - INFO: 资源类型分布 - downloader: 2, pipeline: 1, session: 2
2026-01-11 20:10:00,002 - [SchedulerDaemon] - INFO: 垃圾回收完成 - 回收对象数: 0
```

### 资源泄露检测

如果检测到资源泄露，会输出警告信息：

```
2026-01-11 20:10:00,003 - [SchedulerDaemon] - WARNING: 检测到 2 个潜在资源泄露
2026-01-11 20:10:00,004 - [SchedulerDaemon] - WARNING:   - downloader_12345 (生命周期: 3605.23s)
2026-01-11 20:10:00,005 - [SchedulerDaemon] - WARNING:   - session_67890 (生命周期: 3610.45s)
```

### 配置说明

| 参数 | 默认值 | 说明 |
|------|---------|------|
| `SCHEDULER_RESOURCE_MONITOR_ENABLED` | True | 是否启用资源监控 |
| `SCHEDULER_RESOURCE_CHECK_INTERVAL` | 300 | 资源检查间隔（秒），默认5分钟 |
| `SCHEDULER_RESOURCE_LEAK_THRESHOLD` | 3600 | 资源泄露检测阈值（秒），默认1小时 |

### 注意事项

1. **psutil 依赖**：资源监控功能需要安装 `psutil` 库，如果没有安装会自动禁用
2. **性能影响**：资源监控会定期执行垃圾回收，可能会对性能产生轻微影响
3. **长期运行**：建议启用资源监控，以确保长时间运行时资源使用正常

## 📅 Cron 表达式

Cron 表达式格式：`分 时 日 月 周`

### 常用示例

| Cron 表达式 | 说明 |
|------------|------|
| `*/1 * * * *` | 每1分钟执行一次 |
| `*/2 * * * *` | 每2分钟执行一次 |
| `*/5 * * * *` | 每5分钟执行一次 |
| `0 * * * *` | 每小时执行一次 |
| `0 */2 * * *` | 每2小时执行一次 |
| `0 0 * * *` | 每天凌晨执行一次 |
| `0 0 * * 1` | 每周一凌晨执行一次 |
| `0 0 1 * *` | 每月1号凌晨执行一次 |

## 📊 运行状态

调度器会自动按配置的时间间隔执行爬虫任务，每次执行都会输出详细的日志信息。

### 执行日志示例

```
2026-01-11 19:48:00,000 - [SchedulerDaemon] - INFO: 执行定时任务: of_week
2026-01-11 19:48:00,001 - [of_week] - INFO: 爬取任务开始
...
2026-01-11 19:48:06,000 - [of_week] - INFO: 爬取任务结束
2026-01-11 19:48:06,001 - [SchedulerDaemon] - INFO: 定时任务完成: of_week
2026-01-11 19:48:06,002 - [SchedulerDaemon] - INFO: 下次运行时间: 2026-01-11 19:50:00 (距离: 1 分钟)
2026-01-11 19:48:06,003 - [SchedulerDaemon] - INFO: 任务执行完成标记: of_week
```

## ❓ 常见问题

### Q: 如何修改调度间隔？

A: 修改 `ofweek_standalone/settings.py` 中的 `cron` 表达式，然后重启调度器。

### Q: 如何禁用定时任务？

A: 将 `SCHEDULER_ENABLED` 设置为 `False`，或者将任务配置中的 `enabled` 设置为 `False`。

### Q: 如何查看任务执行统计？

A: 调度器会在日志中输出任务执行统计信息。

### Q: 如何禁用资源监控？

A: 将 `SCHEDULER_RESOURCE_MONITOR_ENABLED` 设置为 `False`。

### Q: 资源监控会影响性能吗？

A: 资源监控会定期执行垃圾回收，可能会对性能产生轻微影响。如果不需要监控，可以禁用。

### Q: 如何安装 psutil？

A: 运行 `pip install psutil` 安装资源监控所需的依赖。

## 📚 更多文档

详细文档请参考：[定时任务调度器使用文档](../../docs/scheduler_guide.md)
